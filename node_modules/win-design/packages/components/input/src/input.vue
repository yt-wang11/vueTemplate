<template>
  <span :class="[type !=='textarea' ? 'w-input' : 'w-textarea', {
    'is-disabled': disabled,
    'is-center': isCenter,
    'is-expansion': $slots['pre-append'] || $slots['suf-append'],
    [`w-input--${inputSize}`]: inputSize && type !== 'textarea'
    }]"
    @mouseenter="handleHoveringStatus(true)"
    @mouseleave="handleHoveringStatus(false)">
  <!-- input -->
  <template v-if="type !== 'textarea'">
    <span v-if="$slots['pre-append']"
      class="w-input__expansion is-pre-append">
      <slot name="pre-append"></slot>
    </span>
    <span :class="['w-input__wrapper', {
      'is-button-expansion': sufAppendIsButton
    }]">
      <i v-if="prefixIcon"
        :class="['w-input__prefix', 'w-input__icon', prefixIcon]"></i>
      <template v-if="!showClearIcon">
        <i v-if="suffixIcon"
          :class="['w-input__suffix', 'w-input__icon', suffixIcon]"></i>
        <slot name="suffix"></slot>
      </template>
      <!-- 清空内容按钮 -->
      <i v-if="showClearIcon" class="w-input__icon w-icon-close"
        title="清空" @click="handleClear" />
      <input v-model="model" v-bind="$attrs"
        ref="input" class="w-input__inner" :placeholder="placeholder"
        :style="isShowCounter ? inputPaddingRight : ''"
        :type="type" :disabled="disabled" :readonly="readonly"
        :maxlength="maxlength" :minlength="minlength" :autocomplete="autocomplete"
        @change="handleChange" @blur="handleBlur" @focus="handleFocus" />
      <span v-show="isFocus" class="w-input__border-bottom"></span>
      <w-counter v-if="isShowCounter" :current="(value + '').length"
        :total="maxlength"></w-counter>
    </span>
    <template v-if="$slots['suf-append']">
      <span v-if="!sufAppendIsButton"
        :class="['w-input__expansion', 'is-suf-append']">
        <slot name="suf-append"></slot>
      </span>
      <button v-else class="w-input__expansion is-suf-append is-button"
        @click="handleSufAppendClick">
        <slot name="suf-append"></slot>
      </button>
    </template>
  </template>
  <!-- textarea -->
  <template v-else>
    <textarea v-model="model" v-bind="$attrs"
      ref="textarea" class="w-textarea__inner"
      :disabled="disabled" :readonly="readonly" :placeholder="placeholder"
      :maxlength="maxlength" :minlength="minlength"
      :rows="rows" :autocomplete="autocomplete"
      @change="handleChange" @blur="handleBlur" @focus="handleFocus" >
    </textarea>
    <span v-show="isFocus" class="w-input__border-bottom"></span>
  </template>
  </span>
</template>

<script>
import WCounter from '../../counter'
import Emitter from '../../../mixins/emitter'
export default {
  name: 'WInput',
  data () {
    return {
      isFocus: false,
      hovering: false
    }
  },
  inheritAttrs: false,
  inject: {
    wForm: {
      default: ''
    },
    wFormItem: {
      default: ''
    }
  },
  props: {
    autocomplete: String,
    clearable: {
      type: Boolean,
      default: false
    },
    disabled: Boolean,
    isCenter: Boolean,
    sufAppendIsButton: Boolean,
    maxlength: {
      type: Number
    },
    minlength: {
      type: Number
    },
    placeholder: {
      type: String,
      default: '请输入内容'
    },
    prefixIcon: {
      type: String
    },
    rows: Number,
    readonly: Boolean,
    showCounter: Boolean,
    size: {
      type: String,
      default: 'medium'
    },
    suffixIcon: {
      type: String
    },
    type: {
      type: String,
      default: 'text'
    },
    value: {}
  },
  components: {
    WCounter
  },
  computed: {
    inputSize () {
      if (!this.wForm || !this.wForm.$props.sizes) return this.size
      return this.wForm.$props.sizes
    },
    inputPaddingRight () {
      let paddingR = `${10 * ((this.maxlength + '').length * 2 + 1) + 8}px`
      return `padding-right: ${paddingR}`
    },
    isShowCounter () {
      return this.maxlength !== undefined && this.showCounter
    },
    model: {
      get () {
        return this.value
      },
      set (val) {
        this.$emit('input', val)
      }
    },
    showClearIcon () {
      return this.clearable && this.value !== '' && (this.isFocus || this.hovering)
    }
  },
  mixins: [Emitter],
  methods: {
    handleHoveringStatus (status) {
      this.hovering = status
    },
    handleChange (ev) {
      const {value} = ev.target
      this.$emit('change', value)
      this.dispatchEvent('WFormItem', 'w.form.field.change')
    },
    handleFocus (ev) {
      this.isFocus = true
      this.$emit('focus', ev)
    },
    handleBlur (ev) {
      this.isFocus = false
      this.$emit('blur', ev)
      this.dispatchEvent('WFormItem', 'w.form.field.blur')
    },
    getInput () {
      return this.$refs.input || this.$refs.textarea
    },
    focus () {
      this.getInput().focus()
    },
    handleClear () {
      this.$emit('input', '')
      this.$emit('change', '')
      this.dispatchEvent('WFormItem', 'w.form.field.change')
    },
    handleSufAppendClick () {
      this.$emit('sufAppendClick')
    }
  }
}
</script>
