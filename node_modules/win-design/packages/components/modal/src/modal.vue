 <template>
   <transition name="modal-fade"
               @after-enter="afterEnter"
               @after-leave="afterLeave">
     <div class="w-modal__wrapper" v-show="visible"  @click.self="handleWrapperClick">
      <div class="w-modal"
           aria-modal="true"
           :aria-label="title || 'dialog'"
           :style="style"
           ref="modal"
           :class="[{ 'is-fullscreen': fullscreen, 'w-modal--center': center }, customClass]">
        <div class="w-modal__header"
             :class="[{'is-color': color}]">
          <slot name="title">
            <span class="w-modal__header__title">{{ title }}</span>
          </slot>
          <button
            type="button"
            v-if="showClose"
            class="w-modal__header__btn"
            aria-label="Close">
            <i class="w-modal__close w-icon w-icon-close"
               @click="handleClose"></i>
          </button>
        </div>
        <div v-if="rendered" class="w-modal__body">
          <slot></slot>
        </div>
        <div class="w-modal__footer">
          <slot name="footer"></slot>
        </div>
      </div>
    </div>
   </transition>
  </template>
<script>
import Popup from '../../../utils/popup'
import Migrating from '../../../mixins/migrating'
import emitter from '../../../mixins/emitter'
export default {
  name: 'WModal',
  mixins: [Popup, emitter, Migrating],
  props: {
    title: {
      type: String,
      default: ''
    },
    visible: {
      type: Boolean,
      default: false
    },
    modal: {
      type: Boolean,
      default: true
    },
    showClose: {
      type: Boolean,
      default: true
    },
    modalAppendToBody: {
      type: Boolean,
      default: true
    },
    appendToBody: {
      type: Boolean,
      default: false
    },
    // 是否可以通过点击遮罩关闭 Modal
    closeOnClickModal: {
      type: Boolean,
      default: true
    },
    beforeClose: Function,
    // 是否可以通过按下 ESC 关闭 Modal
    closeOnPressEscape: {
      type: Boolean,
      default: true
    },
    width: String,
    top: {
      type: String,
      default: '20vh'
    },
    // Modal 的自定义类名
    customClass: {
      type: String,
      default: ''
    },
    fullscreen: Boolean,
    center: {
      type: Boolean,
      default: false
    },
    lockScroll: {
      type: Boolean,
      default: true
    },
    color: {
      type: Boolean,
      default: false
    }
  },
  watch: {
    visible (val) {
      if (val) {
        this.closed = false
        this.$emit('open')
        this.$el.addEventListener('scroll', this.updatePopper, {passive: true})
        this.$nextTick(() => {
          this.$refs.modal.scrollTop = 0
        })
        if (this.appendToBody) {
          document.body.appendChild(this.$el)
        } else {
          return false
        }
      } else {
        this.$el.removeEventListener('scroll', this.updatePopper, {passive: true})
        if (!this.closed) this.$emit('close')
      }
    }
  },
  data () {
    return {
      closed: false
    }
  },
  mounted () {
    if (this.visible) {
      this.rendered = true
      this.open()
      if (this.appendToBody) {
        document.body.appendChild(this.$el)
      }
    }
  },
  computed: {
    style () {
      let _style = {}
      if (!this.fullscreen) {
        _style.marginTop = this.top
        if (this.width) {
          _style.width = this.width
        }
      }
      return _style
    }
  },
  methods: {
    handleWrapperClick () {
      if (!this.closeOnClickModal) return
      this.handleClose()
    },
    handleClose () {
      if (typeof this.beforeClose === 'function') {
        this.beforeClose(this.hide)
      } else {
        this.hide()
      }
    },
    hide (cancel) {
      if (cancel !== false) {
        this.$emit('update:visible', false)
        this.$emit('close')
        this.closed = true
      }
    },
    updatePopper () {
      this.broadcast('WSelectDropdown', 'updatePopper')
      this.broadcast('WDropdownMenu', 'updatePopper')
    },
    afterEnter () {
      this.$emit('opened')
    },
    afterLeave () {
      this.$emit('closed')
    }
  }
}
</script>
