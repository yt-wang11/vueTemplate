<template>
  <div :class="['w-menu-item', {
    'collapse-menu-item': collapse,
    'default-opened': isDefaultOpened(),
    'is-actived': isMenuItemActived,
    'is-disabled': disabled,
    'is-custom-bg': styleConfig && styleConfig.activedBackground
    }]" :style="{...menuItemStyle, backgroundColor: customBackground}"
    @click="handleClick"
    @mouseenter="setHoverStatus(true)"
    @mouseleave="setHoverStatus(false)">
    <w-tooltip v-if="!isSubmenuChild && this.collapse && $slots.title"
      placement="right" theme="dark">
      <div slot="reference">
        <slot></slot>
      </div>
      <slot name="title"></slot>
    </w-tooltip>
    <div v-else class="w-menu-item--content">
      <slot></slot>
      <slot name="title"></slot>
    </div>
  </div>
</template>

<script>
import Emitter from '../../../mixins/emitter'
import {findAncestorNode, getParentsCounter} from '../../../utils/utils'
import WTooltip from '../../tooltip'
export default {
  name: 'WMenuItem',
  data () {
    return {
      menuItemStyle: null,
      customBackground: null,
      isMenuHover: false
    }
  },
  inject: ['wMenu'],
  props: {
    disabled: Boolean,
    index: String
  },
  mixins: [Emitter],
  components: {
    WTooltip
  },
  computed: {
    collapse () {
      return this.wMenu && this.wMenu.$props.collapse
    },
    isHorizontal () {
      return this.wMenu && this.wMenu.$props.mode === 'horizontal'
    },
    isCustom () {
      return Boolean(this.styleConfig && Object.keys(this.styleConfig).length)
    },
    currentActived () {
      return this.wMenu && this.wMenu.$data.actived
    },
    isMenuItemActived () {
      return this.currentActived === this.index
    },
    styleConfig () {
      return this.wMenu && this.wMenu.$props.styleConfig
    },
    defaultActived () {
      return this.wMenu && this.wMenu.$props.defaultActived
    },
    defaultHoverBackground () {
      return this.wMenu && this.wMenu.$data.defaultHoverBackground
    },
    isSubmenuChild () {
      return findAncestorNode(this.$parent, 'WSubmenu')
    },
    isVerticalSubmenuChild () {
      return !this.isHorizontal && this.isSubmenuChild
    },
    defaultOpenedMenu () {
      return this.wMenu && this.wMenu.$props.defaultOpened
    }
  },
  methods: {
    isDefaultOpened () {
      if (this.isHorizontal && !this.collapse) {
        return this.defaultOpenedMenu && this.defaultOpenedMenu.includes(this.index) || this.defaultActived && this.defaultActived === this.index
      }
    },
    getMenuItemParentsCount () {
      return getParentsCounter({
        context: this,
        root: 'WMenu',
        target: 'WSubmenu'
      }) + 1
    },
    setHoverStatus (val) {
      this.isMenuHover = val
    },
    renderMenuItemCustomStyle () {
      // 横栏状态的子级菜单默认样式
      if (!this.isHorizontal && this.isSubmenuChild) return
      // 自定义样式
      const {
        textColor,
        activedTextColor,
        disabledTextColor,
        activedBorder,
        activedBackground
      } = this.styleConfig
      let style = this.isMenuItemActived ? {
        color: activedTextColor,
        borderColor: activedBorder || activedBackground,
        backgroundColor: activedBackground
      } : {
        color: this.disabled
          ? disabledTextColor
          : textColor
      }
      this.customBackground = style.backgroundColor
      return this.isHorizontal ? {
        ...style,
        paddingLeft: !this.collapse ? `${this.getMenuItemParentsCount() * 25}px` : null
      } : style
    },
    handleClick (e) {
      if (this.disabled) return
      if (this.isSubmenuChild) {
        e.stopPropagation()
      }
      this.dispatchEvent('WMenu', 'menu-item-click', {
        index: this.index,
        node: findAncestorNode(this.$parent, 'WSubmenu')
      })
    },
    initMenuItemDefaultStyle () {
      if (!this.isHorizontal) return
      return {
        paddingLeft: !this.collapse ? `${this.getMenuItemParentsCount() * 25}px` : null
      }
    },
    initMenuItemStyle () {
      this.menuItemStyle = this.isCustom
        ? this.renderMenuItemCustomStyle()
        : this.initMenuItemDefaultStyle()
    },
    handleHoverStatusChange (hoverStatus) {
      const { hoverBackground, activedBackground } = this.styleConfig
      this.menuItemStyle = this.renderMenuItemCustomStyle()
      this.customBackground = !this.isMenuItemActived
        ? (hoverStatus ? hoverBackground || this.defaultHoverBackground : null)
        : activedBackground
    },
    handleActivedChange (isActived) {
      const { activedBackground } = this.styleConfig
      this.customBackground = isActived ? activedBackground : null
      !isActived && (this.menuItemStyle.borderColor = null)
    },
    handleRerenderMenuStyle (isCustom) {
      this.menuItemStyle = isCustom
        ? this.renderMenuItemCustomStyle()
        : this.initMenuItemDefaultStyle()
      // 非自定义 或 横栏子菜单 无背景色
      if (!isCustom || this.isVerticalSubmenuChild) {
        this.customBackground = null
      } else {
        this.isMenuItemActived && !this.disabled && (this.customBackground = this.styleConfig.activedBackground)
      }
    }
  },
  created () {
    this.initMenuItemStyle()
  },
  watch: {
    collapse (val) {
      this.handleRerenderMenuStyle(this.isCustom)
    },
    isCustom (val) {
      this.handleRerenderMenuStyle(val)
    },
    isMenuHover (val) {
      // disabled或非自定义或横栏的子菜单都没有hover状态变化
      if (this.disabled || !this.isCustom || this.isVerticalSubmenuChild) return
      this.isCustom && this.handleHoverStatusChange(val)
    },
    isMenuItemActived (val) {
      // 横栏的子菜单没有actived状态变化
      if (this.isVerticalSubmenuChild) return
      this.isCustom && this.handleActivedChange(val)
    }
  }
}
</script>
