<template>
  <div class="w-dropdown">
    <span v-if="iconTrigger" :class="['w-dropdown-trigger']"
      ref="reference">
      <w-button-group>
        <w-button :size="size" type="primary"
          @click="handleButtonClick">
          <slot></slot>
        </w-button>
        <w-button :size="size" type="primary"
          icon="w-icon-arrow-bottom"
          @mouseenter="handleMouseenter"
          @mouseleave="handleMouseleave">
        </w-button>
      </w-button-group>
    </span>
    <span v-else class="w-dropdown-trigger"
      @mouseenter="handleMouseenter"
      @mouseleave="handleMouseleave"
      @click="handleTriggerClick" ref="reference">
      <slot></slot>
    </span>
    <transition name="slide-to-bottom">
      <div v-show="showPopper"
        :class="['w-popper', 'w-dropdown-popper', popperClass]"
        ref="popper" :style="{width: popperWidth}"
        @mouseenter="handleMouseenter"
        @mouseleave="handleMouseleave">
       <slot name="dropdown-menu"></slot>
      </div>
    </transition>
  </div>
</template>
<script>
import PopperMixin from '../../../mixins/popper'
import WButton from '../../button'
import WButtonGroup from '../../button-group'
import {bindEvents, unBindEvents} from '../../../utils/events'
const triggerValidator = (val) => ['hover', 'click'].indexOf(val) > -1
export default {
  name: 'WDropdown',
  data () {
    return {
      popperWidth: ''
    }
  },
  props: {
    iconTrigger: Boolean,
    popperClass: String,
    size: {
      type: String,
      default: 'medium'
    },
    trigger: {
      type: String,
      default: 'hover',
      validator: val => triggerValidator(val)
    },
  },
  components: {
    WButton,
    WButtonGroup
  },
  mixins: [PopperMixin],
  methods: {
    handleDocumentClick (e) {
      if (this.referenceElement && this.referenceElement.contains(e.target)) return
      this.hiddenPopover()
    },
    handleButtonClick () {
      this.$emit('button-click')
    },
    handleMouseenter () {
      this.trigger === 'hover' && this.showPopover()
    },
    handleMouseleave () {
      this.trigger === 'hover' && this.hiddenPopover()
    },
    handleTriggerClick () {
      this.trigger === 'click' && this.togglePopover()
    }
  },
  mounted () {
    const { reference } = this.$slots
    this.referenceElement = reference && reference[0] ? reference[0].elm : this.$refs.reference
    this.referenceElement && (this.popperWidth = `${this.referenceElement.clientWidth}px`)
    this.trigger === 'click' && bindEvents(document, 'click', this.handleDocumentClick)
    this.$on('dropdown-item-click', (e) => {
      this.hiddenPopover()
    })
  },
  beforeDestroy () {
    unBindEvents(document, 'click', this.handleDocumentClick)
  },
  watch: {
    showPopper (val) {
      this.$emit('toggle', this.showPopper)
    }
  }
}
</script>
