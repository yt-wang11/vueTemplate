<template>
  <div :class="['w-menu', {
    'w-menu--collapse': collapse,
    [`is-${theme}`]: theme,
    'is-custom': styleConfig && Object.keys(styleConfig).length,
    'is-horizontal': mode === 'horizontal'
  }]" :style="renderMenuStyle">
    <slot></slot>
  </div>
</template>

<script>
import Emitter from '../../../mixins/emitter'
export default {
  name: 'WMenu',
  data () {
    return {
      actived: '',
      openedMenus: [],
      defaultHoverBackground: 'rgba(255,255,255, .3)'
    }
  },
  provide () {
    return {
      wMenu: this
    }
  },
  props: {
    collapse: Boolean,
    defaultActived: String,
    defaultOpened: Array,
    mode: {
      type: String,
      default: 'vertical'
    },
    styleConfig: {
      type: Object
    },
    theme: {
      type: String,
      default: 'light'
    },
    trigger: {
      type: String,
      default: 'click'
    },
    uniqueOpened: Boolean
  },
  mixins: [Emitter],
  computed: {
    isCustom () {
      return Boolean(this.styleConfig && Object.keys(this.styleConfig).length)
    },
    renderMenuStyle () {
      if (!this.isCustom) return
      return {
        backgroundColor: this.styleConfig.backgroundColor
      }
    }
  },
  methods: {
    addOpenedMenu (val) {
      this.openedMenus.push(val)
    },
    deleteOpenedMenu (val) {
      const index = this.openedMenus.indexOf(val)
      index !== -1 && this.openedMenus.splice(index, 1)
    },
    hiddenParentsPopper ({context, root, prop}) {
      let node = context
      while (node && node[prop] !== undefined) {
        node[prop] = false
        node = node.$parent
      }
    }
  },
  created () {
    this.defaultActived && (this.actived = this.defaultActived)
  },
  mounted () {
    this.$on('menu-item-click', ({index, node}) => {
      if (this.actived === index) return
      this.actived = index
      this.$emit('select', this.actived)
      // 非侧栏展开形态外, 均需要尝试关闭popper
      if (this.mode === 'horizontal' && !this.collapse) return
      this.hiddenParentsPopper({
        context: node,
        root: 'WMenu',
        prop: 'showPopper'
      })
    })
    this.$on('submenu-toggle', ({index, status, isChild}) => {
      this.$emit('toggle-submenu', {
        index,
        status
      })
      if (status && !this.openedMenus.length) {
        this.addOpenedMenu(index)
        return
      }
      status && this.uniqueOpened && !isChild && (this.openedMenus = [])
      status
        ? this.addOpenedMenu(index)
        : this.deleteOpenedMenu(index)
    })
  }
}
</script>
