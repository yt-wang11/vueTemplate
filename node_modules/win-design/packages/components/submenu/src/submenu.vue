<template>
  <div :class="['w-submenu', {
    'is-disabled': disabled,
    'is-custom-bg': styleConfig && styleConfig.activedBackground
  }]" ref="reference" :style="customStyle"
    @click.stop="handleClickSubmenu"
    @mouseenter="handleMouseenter"
    @mouseleave="handleMouseleave">
    <div :class="['w-submenu--content',
      [`is-${isOpenSubmenu ? 'open' : 'hidden'}`], {
        'is-actived': isSubmenuActived,
        'collapse-submenu-content': collapse
      }]"
      :style="{...contentStyle, backgroundColor: customBackground}"
      @mouseenter="setHoverStatus(true)"
      @mouseleave="setHoverStatus(false)">
      <div class="w-submenu--title">
        <slot name="sub-title"></slot>
      </div>
      <i class="collapse-icon w-icon-triangle-bottom" />
    </div>
    <!-- collapse -->
    <template v-if="isHorizontal && !collapse">
      <collapse-transition>
        <div v-show="isOpenSubmenu" key="collapse"
          ref="collapse" :class="['w-submenu--wrapper']"
          :style="wrapperStyle">
          <slot></slot>
        </div>
      </collapse-transition>
    </template>
    <!-- popper -->
    <template v-else>
      <transition name="fade-in-linear">
        <div v-show="isOpenSubmenu" key="popper"
          :class="['w-popper w-submenu-popper', popperClass]"
          ref="popper" :style="{ width }">
          <slot></slot>
        </div>
      </transition>
    </template>
  </div>
</template>

<script>
import Emitter from '../../../mixins/emitter'
import CollapseTransition from '../../../transitions/collapse-transition'
import PopperMixin from '../../../mixins/popper'
import {bindEvents, unBindEvents} from '../../../utils/events'
import {findAncestorNode, getParentsCounter} from '../../../utils/utils'
export default {
  name: 'WSubmenu',
  data () {
    return {
      customBackground: null,
      contentStyle: null,
      isSubmenuActived: false,
      showCollapse: false,
      isMenuHover: false
    }
  },
  props: {
    disabled: Boolean,
    index: String,
    width: String,
    popperClass: String,
    appendToBody: {
      type: Boolean,
      default: false
    }
  },
  inject: ['wMenu'],
  components: {
    CollapseTransition
  },
  computed: {
    collapse () {
      return this.wMenu && this.wMenu.$props.collapse
    },
    openedMenus () {
      return this.wMenu && this.wMenu.$data.openedMenus
    },
    isOpenSubmenu () {
      if (this.disabled) return false
      return !this.isUniqueOpened
        ? (this.isHorizontal && !this.collapse) ? this.showCollapse : this.showPopper
        : this.openedMenus.includes(this.index)
    },
    isUniqueOpened () {
      return this.wMenu && this.wMenu.$props.uniqueOpened
    },
    isCustom () {
      return Boolean(this.styleConfig && Object.keys(this.styleConfig).length)
    },
    wrapperStyle () {
      if (!this.isHorizontal || !this.isCustom) return {}
      return {
        backgroundColor: this.styleConfig.submenuBackground
      }
    },
    isHorizontal () {
      return this.wMenu && this.wMenu.$props.mode === 'horizontal'
    },
    currentActived () {
      return this.wMenu && this.wMenu.$data.actived
    },
    trigger () {
      return this.wMenu && this.wMenu.$props.trigger
    },
    isSubmenuChild () {
      return findAncestorNode(this.$parent, 'WSubmenu')
    },
    isVerticalSubmenuChild () {
      return !this.isHorizontal && this.isSubmenuChild
    },
    customStyle () {
      if (!this.isCustom || this.isVerticalSubmenuChild) return
      // 自定义样式
      const {
        textColor,
        activedTextColor,
        disabledTextColor,
        activedBorder,
        activedBackground} = this.styleConfig
      return this.isSubmenuActived ? {
        color: this.disabled
          ? disabledTextColor
          : activedTextColor,
        borderColor: this.disabled
          ? 'transparent'
          : activedBorder || activedBackground || activedTextColor,
        backgroundColor: this.disabled
          ? 'transparent'
          : activedBackground
      } : {
        color: this.disabled
          ? disabledTextColor
          : textColor
      }
    },
    styleConfig () {
      return this.wMenu && this.wMenu.$props.styleConfig
    },
    defaultHoverBackground () {
      return this.wMenu && this.wMenu.$data.defaultHoverBackground
    },
    parentCounter () {
      return getParentsCounter({
        context: this,
        root: 'WMenu',
        target: 'WSubmenu'
      }) + 1
    }
  },
  mixins: [PopperMixin, Emitter],
  methods: {
    setHoverStatus (val) {
      this.isMenuHover = val
    },
    renderContentStyle () {
      if (!this.isHorizontal) return
      return {
        paddingLeft: !this.collapse ? `${this.parentCounter * 25}px` : null
      }
    },
    handleClickSubmenu () {
      // 侧栏折叠不支持点击
      if (this.isHorizontal && this.collapse || this.trigger === 'hover') return
      this.toggleSubmenu()
    },
    toggleSubmenu (status) {
      if (this.isHorizontal && !this.collapse) {
        // 侧栏展开
        this.showCollapse = status === undefined
          ? !this.showCollapse
          : status
      } else {
        // 其他
        status === undefined
          ? this.showPopper = !this.showPopper
          : status ? this.showPopover() : this.hiddenPopover()
      }
    },
    handleMouseenter () {
      if (this.collapse && this.isHorizontal) {
        this.showPopover()
        return
      }
      this.trigger === 'hover' && this.toggleSubmenu(true)
    },
    handleMouseleave () {
      if (this.collapse && this.isHorizontal) {
        this.hiddenPopover()
        return
      }
      this.trigger === 'hover' && this.toggleSubmenu(false)
    },
    isSubmenuItemActived () {
      return this.$refs.popper && this.$refs.popper.querySelector('div.w-menu-item.is-actived') !== null
    },
    initContentStyle () {
      this.contentStyle = this.renderContentStyle()
    },
    initPopperStyle () {
      if (!this.$refs.popper) return 0
      this.currentOffset = () => {
        let offset = 0
        const parseIntProps = (prop) => parseInt(prop.replace('px', ''))
        const popperStyle = window.getComputedStyle(this.$refs.popper)
        const width = parseIntProps(popperStyle.width)
        const height = parseIntProps(popperStyle.height) + parseIntProps(popperStyle.marginBottom) + 6
        let menuWidth = null
        if (this.wMenu) {
          menuWidth = parseIntProps(window.getComputedStyle(this.wMenu.$el).width)
        }
        offset = this.parentCounter - 1
            ? `${(this.parentCounter - 1) * width}, ${-height}`
            : this.collapse ? `${menuWidth || 65}, ${-height}` : 0
        return offset
      }
    },
    dispatchEventToMenu (prop) {
       this.dispatchEvent('WMenu', 'submenu-toggle', {
        index: this.index,
        status: this[prop],
        isChild: this.isSubmenuChild
      })
    },
    unBindAllEvents () {
      unBindEvents(document, 'click', this.handleDocumentClick)
    },
    handleDocumentClick (e) {
      const popper = this.$refs.popper
      if (!this.referenceElement) return
      if (this.referenceElement.contains(e.target)) return
      this.hiddenPopover()
    },
    bindEventsForMask () {
      const { reference } = this.$slots
      this.referenceElement = this.$refs.reference
      if (!this.referenceElement) return
      bindEvents(document, 'click', this.handleDocumentClick)
    },
    handleDefaultOpened () {
      if (this.isHorizontal && !this.collapse) {
        const isChildDefaultOpened = this.$el.querySelector('div.default-opened')
        isChildDefaultOpened && (this.showCollapse = true)
      }
    }
  },
  created () {
    this.initContentStyle()
  },
  mounted () {
    this.isSubmenuActived = this.isSubmenuItemActived()
    this.handleDefaultOpened()
    if (this.isHorizontal) return
    if (this.trigger === 'click' && !this.isHorizontal) {
     this.bindEventsForMask()
    }
  },
  beforeDestroy () {
    if (this.trigger === 'click' && !this.isHorizontal) {
      this.unBindAllEvents()
    }
  },
  watch: {
    collapse (val) {
      // 重新计算样式
      this.initContentStyle()
      this.showCollapse = false
      this.showPopper = false
    },
    isOpenSubmenu (val) {
      if (!val && this.isHorizontal) {
        // 同步开关
        this.showCollapse = false
      }
      const needReComputedPopperStyle = val && (!this.isHorizontal || this.isHorizontal && this.collapse)
      // 横栏或折叠状态打开时 初始化popper的style
      needReComputedPopperStyle && this.initPopperStyle()
    },
    isMenuHover (val) {
      if (!this.isCustom) return
      this.customBackground = val
        ? this.styleConfig.hoverBackground || this.defaultHoverBackground
        : ''
    },
    currentActived (val) {
      this.$nextTick(() => {
        this.isSubmenuActived = this.isSubmenuItemActived()
      })
    },
    showCollapse (val) {
      this.dispatchEventToMenu('showCollapse')
    },
    showPopper (val) {
      if (this.disabled) return
      this.dispatchEventToMenu('showPopper')
    }
  }
}
</script>
