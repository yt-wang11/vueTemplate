<template>
    <div class="w-affix" :style="wrapStyle">
      <div :class="{'affix': affixed}" :style="styles">
        <slot></slot>
      </div>
    </div>
</template>

<script>
export default {
  name: 'WAffix',
  props: {
    offsetTop: {
      type: Number,
      default: 0
    },
    offsetBottom: {
      type: Number
    },
    onAffix: {
      type: Function,
      default () {}
    },
    boundary: {
      type: String,
      default: ''
    }
  },
  data () {
    return {
      affixedClientHeight: 0,
      affixed: false,
      styles: {},
      wrapStyle: {}
    }
  },
  computed: {
    offsets () {
      if (this.boundary) {
        return 0
      }
      return this.offsetTop
    },
    offsetType () {
      let type = 'top'
      if (this.offsetBottom >= 0) {
        type = 'bottom'
      }
      return type
    }
  },
  methods: {
    getScroll (w, top) {
      let ret = w[`page${(top ? 'Y' : 'X')}Offset`]
      const method = `scroll${top ? 'Top' : 'Left'}`
      if (typeof ret !== 'number') {
        const d = w.document
        ret = d.documentElement[method]
      }
      return ret
    },
    getOffset (e) {
      let rect = e.getBoundingClientRect()
      let body = document.body
      let clientTop = e.clientTop || body.clientTop || 0
      let clientLeft = e.clientLeft || body.clientLeft || 0
      let scrollTop = this.getScroll(window, true)
      let scrollLeft = this.getScroll(window)
      return {
        top: rect.bottom + scrollTop - clientTop - this.affixedClientHeight,
        left: rect.left + scrollLeft - clientLeft
      }
    },
    handleScroll () {
      let scrollTop = this.getScroll(window, true) + this.offsets // handle setting offset
      let elementOffset = this.getOffset(this.$el)
      let windowHeight = window.innerHeight
      let elHeight = this.$el.getElementsByTagName('div')[0].offsetHeight
      // Fixed Top
      if (this.offsetType === 'top') {
        if (!this.affixed && scrollTop > elementOffset.top) {
          this.affixed = true
          this.styles = {
            top: `${this.offsets}px`,
            left: `${elementOffset.left}px`,
            width: `${this.$el.offsetWidth}px`
          }
          this.onAffix(this.affixed)
        }
        if (this.affixed && scrollTop < elementOffset.top) {
          this.affixed = false
          this.styles = {}
          this.onAffix(this.affixed)
        }
      } else {
        // Fixed Bottom
        if (!this.affixed && (elementOffset.top + this.offsetBottom + elHeight) > (scrollTop + windowHeight)) {
          this.affixed = true
          this.styles = {
            bottom: `${this.offsetBottom}px`,
            left: `${elementOffset.left}px`,
            width: `${this.$el.offsetWidth}px`
          }
          this.onAffix(this.affixed)
        }
        if (this.affixed && (elementOffset.top + this.offsetBottom + elHeight) < (scrollTop + windowHeight)) {
          this.affixed = false
          this.styles = null
          this.onAffix(this.affixed)
        }
      }
    }
  },
  mounted () {
    this.affixedClientHeight = this.$el.children[0].clientHeight
    this.wrapStyle = {
      height: this.affixedClientHeight + 'px'
    }
    window.addEventListener('scroll', this.handleScroll, true)
    window.addEventListener('resize', this.handleScroll, true)
  },
  beforeDestroy () {
    window.removeEventListener('scroll', this.handleScroll, true)
    window.removeEventListener('resize', this.handleScroll, true)
  }
}
</script>
<style scoped lang="scss">
  .affix {
    position: fixed
  }
</style>
