<template>
  <label :class="['w-checkbox', {
    'is-disabled': disabled,
    'is-checked': isChecked,
    'is-border': border,
    'is-indeterminate': indeterminate
  }]">
    <span :class="['w-checkbox__input']">
      <span class="w-checkbox__inner"></span>
      <input v-model="model" class="w-checkbox__native"
             type="checkbox" :value="label"
             :name="name" :disabled="disabled"
             @change="handleChange" />
    </span>
    <span v-if="label || $slots.default" class="w-checkbox__label">
      <slot></slot>
      <span v-if="!$slots.default" v-text="label"></span>
    </span>
  </label>
</template>

<script>
import Emitter from '../../../mixins/emitter'
import {findAncestorNode} from '../../../utils/utils'
export default {
  name: 'WCheckbox',
  data () {
    return {
      parentName: 'WCheckboxGroup'
    }
  },
  inject: {
    wForm: {
      default: ''
    },
    wFormItem: {
      default: ''
    }
  },
  props: {
    border: Boolean,
    checkout: Boolean,
    disabled: Boolean,
    label: {},
    indeterminate: Boolean,
    name: String,
    value: {}
  },
  computed: {
    model: {
      get () {
        return this.isCheckboxGroup ? this.ancestor.value : this.value
      },
      set (val) {
        !this.isLimited(val) && (this.isCheckboxGroup ? this.dispatchEvent(this.parentName, 'input', [val]) : this.$emit('input', val))
      }
    },
    isCheckboxGroup () {
      return this.ancestor !== undefined
    },
    isChecked () {
      if (this.isCheckboxGroup && this.label === undefined) {
        return false
      }
      return this.isCheckboxGroup ? this.model.includes(this.label) : this.value
    },
    ancestor () {
      return findAncestorNode(this.$parent, 'WCheckboxGroup')
    },
    max () {
      return this.ancestor && this.ancestor.$props.max
    },
    min () {
      return this.ancestor && this.ancestor.$props.min
    }
  },
  mixins: [Emitter],
  methods: {
    isLimited (current) {
      const {max, min} = this
      const selectedLength = current.length
      const maxLimited = max !== undefined && selectedLength > max
      const minLimited = min !== undefined && selectedLength < min
      return maxLimited || minLimited
    },
    handleChange (ev) {
      const { checked } = ev.target
      this.$emit('change', checked)
      this.dispatchEvent('WFormItem', 'w.form.field.change')
      this.isCheckboxGroup && this.dispatchEvent(this.parentName, 'change', [this.model])
    }
  }
}
</script>
