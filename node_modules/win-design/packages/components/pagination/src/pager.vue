<template>
  <ul class="w-pager">
    <!-- 第一页 -->
    <li v-text="firstPager"
      :class="['w-pager__item', {
      'is-actived': activedPager === firstPager
      }]" @click="handlePagerClick(1)"></li>
    <template v-if="isShowMoreLeftPager">
      <!-- 展开左边页码 -->
      <li class="w-pager__item expansion-left" title="展开更多"
        @mouseenter="handleExpansionIconMouseenter('left')"
        @mouseleave="handleExpansionIconMouseleave"
        @click="handleExpansionMore('left')">
        <i :class="['w-pager__expansion-icon', leftExpansionIcon]"></i>
      </li>
    </template>
    <li v-for="(pager, index) of mainPagers" v-text="pager" :key="index"
      :class="['w-pager__item', {
      'is-actived': activedPager === pager
      }]" @click="handlePagerClick(pager)"></li>
    <template v-if="isShowMoreRightPager">
      <!-- 展开右边页码 -->
      <li class="w-pager__item expansion-right" title="展开更多"
        @mouseenter="handleExpansionIconMouseenter('right')"
        @mouseleave="handleExpansionIconMouseleave"
        @click="handleExpansionMore('right')">
        <i :class="['w-pager__expansion-icon', rightExpansionIcon]"></i>
      </li>
    </template>
    <!-- 最后一页 -->
    <li v-if="firstPager !== lastPager" v-text="lastPager"
    :class="['w-pager__item', {
    'is-actived': activedPager === lastPager
    }]" @click="handlePagerClick(lastPager)"></li>
  </ul>
</template>

<script>
export default {
  name: 'WPager',
  data () {
    return {
      leftExpansionIcon: 'w-icon-more',
      rightExpansionIcon: 'w-icon-more',
      startIndex: 0,
      endIndex: this.maxPager,
      pagerList: []
    }
  },
  props: {
    activedPager: Number,
    maxPager: Number,
    pagers: {
      type: Array
    },
    small: Boolean
  },
  computed: {
    step () {
      return this.maxPager - 4
    },
    isOverflowPager () {
      return !this.small && this.pagers.length > this.maxPager
    },
    isShowMoreRightPager () {
      return this.pagers[this.endIndex] !== this.lastPager && this.isOverflowPager
    },
    isShowMoreLeftPager () {
      return this.pagers[this.startIndex] !== this.firstPager && this.isOverflowPager
    },
    firstPager () {
      return this.pagers[0]
    },
    lastPager () {
      return this.pagers[this.pagers.length - 1]
    },
    mainPagers () {
      const pagers = this.pagers
      let start = this.small ? 1 : this.startIndex + 1
      let end = (this.small || !this.isOverflowPager) ? pagers.length - 1 : this.endIndex
      return pagers.slice(start, end)
    }
  },
  methods: {
    leftExpansion (pagersLen) {
      // 左侧展开
      if (this.startIndex - this.step <= 0) {
        // 展开溢出
        this.setIndex(0, this.maxPager)
      } else if (this.endIndex === pagersLen - 1) {
        // 右侧临界
        let endIndex = this.pagers.findIndex(item => item === this.mainPagers[0]) + 1
        this.setIndex(endIndex - this.maxPager, endIndex)
      } else {
        // 一般情况
        this.setIndex(this.startIndex - this.step, this.endIndex - this.step)
      }
    },
    rightExpansion (pagersLen) {
      // 右侧展开
      if (this.endIndex + this.step >= pagersLen - 1) {
        // 展开溢出
        this.setIndex(this.startIndex + this.step, pagersLen - 1)
      } else {
        // 一般情况
        this.setIndex(this.startIndex + this.step, this.endIndex + this.step)
      }
    },
    handleExpansionMore (direction) {
      const pagersLen = this.pagers.length
      direction === 'left' && this.leftExpansion(pagersLen)
      direction === 'right' && this.rightExpansion(pagersLen)
      this.leftExpansionIcon = this.rightExpansionIcon = 'w-icon-more'
    },
    handleExpansionIconMouseenter (direction) {
      this[`${direction}ExpansionIcon`] = `w-icon-triangle-${direction}`
    },
    handleExpansionIconMouseleave () {
      this.leftExpansionIcon = this.rightExpansionIcon = 'w-icon-more'
    },
    handlePagerClick (current) {
      this.$emit('pagerChange', current)
    },
    setIndex (start, end) {
      this.startIndex = start
      this.endIndex = end
    },
    indexToFirstOrLastPager (val) {
      /**
       * 手动点击至第一页或最后一页
       * @param {Number} val 当前页
       */
      val === this.firstPager && this.setIndex(0, this.maxPager) // 点击第一页
      // 最后一页且溢出
      if (val === this.lastPager) {
        let endIndex = this.pagers.length - 1
        this.setIndex(endIndex - this.maxPager, endIndex)
      }
    },
    expansionIntervalAuto (val, mainPagers) {
      /**
       * 处理自动展开
       * @param {Number} val 当前页
       */
      // 自动向右展开
      this.isShowMoreRightPager && val === mainPagers[mainPagers.length - 1] && this.handleExpansionMore('right')
      // 自动向左展开
      this.isShowMoreLeftPager && val === mainPagers[0] && this.handleExpansionMore('left')
    },
    expansionSpecifiedInterval (val) {
      /**
       * 展开指定区间
       * @param {Number} val 当前页
       */
      if (!this.isOverflowPager) return
      let mainPagers = this.mainPagers
      if (val > mainPagers[0] && val < mainPagers[mainPagers.length - 1]) return
      // 产生页码折叠
      if (val === this.firstPager || val === this.lastPager) {
        // 端点页
        this.indexToFirstOrLastPager(val)
      } else if (val === mainPagers[mainPagers.length - 1] || val === mainPagers[0]) {
        // 展开符临近的值 自动展开
        this.expansionIntervalAuto(val, mainPagers)
      } else {
        // 展开被折叠的页码
        const currentIndex = this.pagers.findIndex(item => item === val)
        this.expansionHiddenPager(currentIndex)
      }
    },
    expansionHiddenPager (currentIndex) {
      /**
       * 展开被折叠的页码
       * @param {Number} currentIndex 用户指定跳转的页码(被折叠的)
       */
      const halfMaxPager = Math.ceil(this.maxPager / 2)
      let endIndex = this.pagers.length - 1
      if (currentIndex - halfMaxPager < 1) {
        // 左溢出
        this.setIndex(0, this.maxPager)
      } else if (currentIndex + halfMaxPager > endIndex) {
        // 右溢出
        this.setIndex(endIndex - this.maxPager, endIndex)
      } else {
        // 一般情况
        this.setIndex(currentIndex - halfMaxPager, currentIndex + halfMaxPager)
      }
    }
  },
  watch: {
    activedPager (val) {
      this.expansionSpecifiedInterval(val) // 否则展开固定区间
    }
  }
}
</script>
