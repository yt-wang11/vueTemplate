<template>
  <span class="w-pagination-wrapper">
    <div :class="['w-pagination', {
    'is-plain': plain
    }]">
      <!-- 总条数 -->
      <span v-if="showTotal" v-text="`共 ${total} 条`"
        class="w-pagination__total"></span>
      <!-- 选择分页大小 -->
      <template v-if="showPageSizes">
        <w-select v-model="pageSizeCustom" size="small" placeholder="请选择"
          @change="handlePageSizeChange">
          <w-option v-for="size in pageSizes"
            :key="size" :label="`${size}条/页`" :value="size">
          </w-option>
        </w-select>
      </template>
      <!-- 上一页 -->
      <w-button v-if="showPrev" class="prev-button"
        plain :disabled="prevStop" icon="w-icon-triangle-left"
        size="small" @click="toPrevPage"></w-button>
      <!-- 页码 -->
      <w-pager :pagers="pagers.length ? pagers : [1]"
        :max-pager="maxPager" :actived-pager="activedPager"
        :small="small" @pagerChange="handlePagerChange"></w-pager>
      <!-- 下一页 -->
      <w-button v-if="showNext" class="next-button"
        plain :disabled="nextStop" icon="w-icon-triangle-right"
        size="small" @click="toNextPage"></w-button>
      <!-- 跳转 -->
      <span v-if="showJump" class="w-pagination__jump">
        前往
        <w-input v-model="jumpTo" size="small" placeholder=""
          isCenter @change="handleJumpTo"></w-input>
        页
      </span> 
    </div>
  </span>
</template>

<script>
import WButton from '../../button'
import WInput from '../../input'
import WPager from './pager'
import WSelect from '../../select'
import WOption from '../../option'
const isPositiveInteger = (val) => Number.isInteger(val * 1) && val * 1 > 0
export default {
  name: 'WPagination',
  data () {
    return {
      pageSizeCustom: 10,
      prevStop: true,
      nextStop: true,
      pagers: [],
      activedPager: 1,
      jumpTo: 1
    }
  },
  components: {
    WButton,
    WPager,
    WInput,
    WSelect,
    WOption
  },
  computed: {
    isShowExpantion () {
      return this.show && Array.isArray(this.show)
    },
    showPageSizes () {
      return this.pageSizes && this.pageSizes.length
    },
    showTotal () {
      return this.isShowExpantion && this.show.includes('total')
    },
    showJump () {
      return this.isShowExpantion && this.show.includes('jump')
    },
    showPrev () {
      return this.isShowExpantion && this.show.includes('prev')
    },
    showNext () {
      return this.isShowExpantion && this.show.includes('next')
    }
  },
  props: {
    maxPager: {
      type: Number,
      default: 8
    },
    plain: Boolean,
    pageSizes: Array,
    pageSize: {
      type: Number,
      default: 10,
      validator: (val) => isPositiveInteger(val)
    },
    show: {
      type: Array,
      default () {
        return ['prev', 'next']
      }
    },
    small: Boolean,
    total: {
      type: Number,
      required: true,
      validator: (val) => isPositiveInteger(val)
    }
  },
  methods: {
    handlePageSizeChange (val) {
      this.initPagers(this.total, val)
    },
    initPagers (total, pageSize) {
      let pagers = Math.ceil(this.total / pageSize)
      if (!pagers) return
      this.pagers = []
      for (let n = 0; n < pagers; n++) {
        this.pagers.push(n + 1)
      }
    },
    initStatusData () {
      this.pagers[0] && (this.jumpTo = this.activedPager = this.pagers[0])
      this.pageSizes && this.pageSize && (this.pageSizeCustom = this.pageSize)
    },
    toPrevPage () {
      this.activedPager -= 1
      this.$emit('to-prev', this.activedPager)
    },
    toNextPage () {
      this.activedPager += 1
      this.$emit('to-next', this.activedPager)
    },
    setPageButtonStatus (prev, next) {
      this.prevStop = prev
      this.nextStop = next
    },
    handleJumpChange (val) {
      this.jumpTo = val
    },
    handleJumpTo (val) {
      const handleActivedPager = (activedPager, jumpTo) => {
        /**
         * @param {Number} activedPager 被激活的页码
         * @param {Number} jumpTo 跳转至 (用于activedPager溢出时, 手动设置jumpTo值)
         */
        this.handlePagerChange(activedPager)
        jumpTo && (this.jumpTo = jumpTo)
      }
      const pagers = this.pagers
      const firstPage = pagers[0] || 1
      const lastPage = pagers[pagers.length - 1] || 1
      if (!isPositiveInteger(val)) {
        this.activedPager === firstPage && (this.jumpTo = firstPage)
        handleActivedPager(firstPage)
        return
      }
      const handleJumpOverflow = (val, firstPage, lastPage) => {
        val > lastPage && handleActivedPager(lastPage, lastPage)
        val < firstPage && handleActivedPager(firstPage)
      }
      const valToNumber = val * 1
      valToNumber <= lastPage && valToNumber >= firstPage
        ? handleActivedPager(valToNumber)
        : handleJumpOverflow(valToNumber, firstPage, lastPage)
    },
    handlePagerChange (val) {
      this.activedPager = val
    },
    handlePageButtonStatus (val) {
      const pager = this.pagers
      this.setPageButtonStatus(val === (pager[0] || 1), val === (pager[pager.length - 1] || 1))
    }
  },
  created () {
    this.initPagers(this.total, this.pageSize)
    this.initStatusData()
    this.handlePageButtonStatus(this.activedPager)
  },
  watch: {
    activedPager (val) {
      this.handlePageButtonStatus(val)
      this.handleJumpChange(val)
      this.$emit('actived-change', val)
    }
  }
}
</script>
