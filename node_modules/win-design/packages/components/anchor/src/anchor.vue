<template>
    <div class="w-anchor" ref="anchor" :style="anchorPosition">
      <span v-show="showItem" ref="anchor-item" :class="['w-anchor__item', {
        'is-actived': actived === currentLink
      }]" :style="`top: ${itemTop}px`"></span>
      <slot></slot>
    </div>
</template>
<script>
import {bindEvents, unBindEvents} from '../../../utils/events'
import smoothScroll from '../../../utils/smooth-scroll'
import {debounce} from 'throttle-debounce'
export default {
  name: 'WAnchor',
  data () {
    return {
      actived: '',
      currentLink: '',
      itemTop: 0,
      showItem: false,
      anchorPosition: '',
      links: []
    }
  },
  provide () {
    return {
      wAnchor: this
    }
  },
  props: {
    duration: Number,
    offset: Number,
    getContainer: {
      type: Function,
      default: () => window
    }
  },
  computed: {
  },
  methods: {
    computedItemTop (target) {
      if (!target) return
      const anchorTop = smoothScroll.getOffsetTop(this.$refs.anchor, this.getContainer)
      const linkItemHeight = getComputedStyle(this.$refs['anchor-item']).height.replace('px', '') * 1 || 8
      const linkHeight = target.clientHeight || 0
      const linkTop = smoothScroll.getOffsetTop(target, this.getContainer)
      return linkTop - anchorTop + (linkHeight - linkItemHeight) / 2 || 0
    },
    handleScroll () {
      const container = this.getContainer()
      if (!container) return
      const currentOffset = container === window ? container.pageYOffset : container.scrollTop
      let out = 0
      this.links.forEach(item => {
        Object.keys(item).forEach(key => {
          if (Math.abs(currentOffset || 0 - item[key]) < 40) {
            this.actived = this.currentLink = key
          } else {
            out++
          }
        })
      })
      if (out === this.links.length) this.actived = ''
    },
    handleActivedLink (target, selector) {
      this.currentLink = selector
      this.showItem = true
      this.itemTop = this.computedItemTop(target)
    }
  },
  mounted () {
    this.$on('linkHover', ({ev, selector}) => {
      this.handleActivedLink(ev.target, selector)
    })
    this.$on('linkClick', ({ev, link}) => {
      this.$emit('onLinkClick', {ev, link})
      this.actived = link.actived || ''
    })
    this.$on('addLink', val => {
      const top = smoothScroll.getOffsetTop(document.querySelector(val), this.getContainer)
      this.links.push({
        [val]: top || 0
      })
    })
    // bindEvents(window, 'scroll', debounce(50, this.handleScroll))
  },
  beforeDestroy () {
    // unBindEvents(window, 'scroll', debounce(50, this.handleScroll))
  }
}
</script>
