<template>
  <span :class="['w-input-number', {
    'is-disabled': disabled,
    'is-focus': isFocus,
    [`w-input-number--${inputNumberSize}`]: inputNumberSize
  }]">
  <span class="w-input-number--controller">
    <span :class="['w-input-number__increase', {
      'is-disabled': increaseLimited
    }]" @click="handleIncrease">
      <i class="w-icon w-icon-triangle-top"></i>
    </span>
    <span :class="['w-input-number__decrease', {
      'is-disabled': decreaseLimited
    }]" @click="handleDecrease">
      <i class="w-icon w-icon-triangle-bottom"></i>
    </span>
  </span>
    <w-input v-model.number="model" :is-center="isCenter" :size="inputNumberSize"
      :disabled="disabled" :placeholder="placeholder" :readonly="readonly"
      :name="name" :label="label"
      @blur="handleBlur" @focus="handleFocus" @change="handleChange"></w-input>
  </span>
</template>
<script>
import Emitter from '../../../mixins/emitter'
import NumberPrecision from 'number-precision'
import WInput from '../../input'
export default {
  name: 'WInputNumber',
  data () {
    return {
      isFocus: false
    }
  },
  inject: {
    wForm: {
      default: ''
    },
    wFormItem: {
      default: ''
    }
  },
  props: {
    disabled: Boolean,
    isCenter: {
      type: Boolean,
      default: true
    },
    increment: Number,
    label: String,
    max: Number,
    min: Number,
    name: String,
    placeholder: {
      type: String,
      default: ''
    },
    readonly: Boolean,
    size: {
      type: String,
      default: 'medium'
    },
    value: {}
  },
  components: {
    WInput
  },
  computed: {
    inputNumberSize () {
      if (!this.wForm || !this.wForm.$props.sizes) return this.size
      return this.wForm.$props.sizes
    },
    model: {
      get () {
        return this.value
      },
      set (val) {
        this.$emit('input', this.setNewValue(val))
      }
    },
    incrementNumber () {
      return this.increment !== undefined ? this.increment : 1
    },
    increaseNumber () {
      return NumberPrecision.plus(this.model, this.incrementNumber)
    },
    decreaseNumber () {
      return NumberPrecision.minus(this.model, this.incrementNumber)
    },
    increaseLimited () {
      return this.max !== undefined && this.increaseNumber > this.max
    },
    decreaseLimited () {
      return this.min !== undefined && this.decreaseNumber < this.min
    }
  },
  mixins: [Emitter],
  methods: {
    setNewValue (val) {
      let newValue = val
      if (typeof newValue === 'number') {
        if (this.max !== undefined && val > this.max) {
          newValue = this.max
        } else if (this.min !== undefined && val < this.min) {
          newValue = this.min
        }
        return newValue
      } else {
        return this.model
      }
    },
    handleChange (val) {
      this.$emit('change', val)
      this.dispatchEvent('WFormItem', 'w.form.field.change')
    },
    handleFocus (ev) {
      this.isFocus = true
      this.$emit('focus', ev)
    },
    handleBlur (ev) {
      this.isFocus = false
      this.$emit('blur', ev)
      this.dispatchEvent('WFormItem', 'w.form.field.blur')
    },
    handleIncrease () {
      const isLimited = this.max === undefined || !this.increaseLimited
      isLimited && !this.disabled && this.$emit('input', this.increaseNumber) && this.handleChange(this.increaseNumber)
    },
    handleDecrease () {
      const isLimited = this.min === undefined || !this.decreaseLimited
      isLimited && !this.disabled && this.$emit('input',  this.decreaseNumber) && this.handleChange(this.decreaseNumber)
    }
  }
}
</script>
