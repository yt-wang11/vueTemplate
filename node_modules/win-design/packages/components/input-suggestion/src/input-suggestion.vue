<template>
  <div class="w-input-suggestion">
    <w-input v-model="input" v-bind="[$attrs, $props]" ref="input"
      @focus="handleFocus" @blur="handleBlur" @input="handleInput">
      <template slot="pre-append">
        <slot name="pre-append"></slot>
      </template>
      <template slot="suf-append">
        <slot name="suf-append"></slot>
      </template>
    </w-input>
    <transition name="slide-to-bottom">
      <div v-show="showPopper" :class="['w-popper', 'w-input-suggestion-popper', popperClass]"
        ref="popper" :style="{width: popperWidth}">
       <div :class="['w-input-suggestion-popper__wrapper']">
        <template v-if="suggestionList.length">
          <span v-for="(item, index) in suggestionList" :key="index"
            class="w-input-suggestion-popper__item" @click.stop="handleItemClick(item)">
            <slot :item="item">
              {{item[valueKey] || item}}
            </slot>
          </span>
        </template>
        <p v-else v-text="emptyPlaceholder || '暂无数据'" class="empty-placeholder"></p>
       </div>
      </div>
    </transition>
  </div>
</template>

<script>
import WInput from '../../input'
import PopperMixin from '../../../mixins/popper'
import {bindEvents, unBindEvents} from '../../../utils/events'
export default {
  name: 'WInputSuggestion',
  data () {
    return {
      input: '',
      popperWidth: '',
      suggestionList: []
    }
  },
  inject: {
    wForm: {
      default: ''
    },
    wFormItem: {
      default: ''
    }
  },
  components: {
    WInput
  },
  props: {
    autofocus: Boolean,
    autocomplete: String,
    clearable: {
      type: Boolean,
      default: false
    },
    disabled: Boolean,
    emptyPlaceholder: String,
    fetchSuggestionList: Function,
    isCenter: Boolean,
    isFocusTrigger: {
      type: Boolean,
      default: true
    },
    maxlength: {
      type: Number
    },
    minlength: {
      type: Number
    },
    placeholder: {
      type: String,
      default: '请输入内容'
    },
    popperClass: String,
    readonly: Boolean,
    size: {
      type: String,
      default: 'medium'
    },
    valueKey: {
      type: String,
      default: 'value'
    }
  },
  mixins: [PopperMixin],
  methods: {
    fetchData (query) {
      this.fetchSuggestionList && this.fetchSuggestionList(query, (list) => {
        if (!Array.isArray(list)) return
        this.suggestionList = list
      })
    },
    handleInput () {
      if (!this.isFocusTrigger && !this.input) {
        this.hiddenPopover()
        return
      }
      this.fetchData(this.input)
      this.showPopover()
    },
    handleFocus () {
      if (!this.isFocusTrigger) return
      this.fetchData(this.input)
      this.showPopover()
    },
    handleBlur () {
      this.hiddenPopover()
    },
    unBindAllEvents () {
      unBindEvents(document, 'click', this.handleDocumentClick)
      unBindEvents(this.$refs.popper, 'click', this.showPopover)
    },
    handleDocumentClick (e) {
      if (this.referenceElement && this.referenceElement.contains(e.target)) return
      this.showPopper = false
    },
    handleItemClick (target) {
      this.input = target[this.valueKey] || target
      this.showPopper = false
      this.$emit('select', target)
    }
  },
  mounted () {
    this.referenceElement = this.$refs.input.$el.querySelector('.w-input__wrapper')
    this.referenceElement && (this.popperWidth = `${this.referenceElement.clientWidth}px`)
    this.$refs.popper && bindEvents(this.$refs.popper, 'click', this.showPopover)
    bindEvents(document, 'click', this.handleDocumentClick)
  },
  beforeDestroy () {
    this.unBindAllEvents()
  },
  watch: {
    input (val) {
      this.$emit('input', val)
    }
  }
}
</script>

<style>

</style>
